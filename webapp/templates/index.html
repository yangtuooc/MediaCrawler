<!DOCTYPE html>
<html lang="zh">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>MediaCrawler Web</title>
    <link
      rel="stylesheet"
      href="https://unpkg.com/element-ui/lib/theme-chalk/index.css"
    />
    <link
      rel="stylesheet"
      href="{{ url_for('static', filename='css/style.css') }}"
    />
  </head>
  <body>
    <div id="app" class="app-container">
      <el-container>
        <el-header>
          <div class="header-content">
            <h1>MediaCrawler Web</h1>
            <el-menu
              mode="horizontal"
              :default-active="currentPage"
              @select="handleSelect"
              background-color="#545c64"
              text-color="#fff"
              active-text-color="#ffd04b"
            >
              <el-menu-item index="高级配置">
                <i class="el-icon-setting"></i>高级配置
              </el-menu-item>
              <el-menu-item index="运行爬虫">
                <i class="el-icon-video-play"></i>运行爬虫
              </el-menu-item>
            </el-menu>
          </div>
        </el-header>
        <el-main>
          <el-form
            ref="form"
            :model="form"
            label-width="120px"
            v-if="currentPage === '高级配置'"
          >
            <el-card class="config-card">
              <div slot="header">
                <span>高级配置</span>
              </div>
              <el-row :gutter="20">
                <el-col :span="12">
                  <el-form-item label="启用IP代理">
                    <el-switch v-model="form.enable_ip_proxy"></el-switch>
                  </el-form-item>
                </el-col>
                <el-col :span="12">
                  <el-form-item label="代理IP池数量">
                    <el-input-number
                      v-model="form.ip_proxy_pool_count"
                      :min="1"
                    ></el-input-number>
                  </el-form-item>
                </el-col>
              </el-row>
              <el-row :gutter="20">
                <el-col :span="12">
                  <el-form-item label="代理IP提供商">
                    <el-input v-model="form.ip_proxy_provider_name"></el-input>
                  </el-form-item>
                </el-col>
                <el-col :span="12">
                  <el-form-item label="用户数据目录">
                    <el-input
                      v-model="form.user_data_dir"
                      placeholder="例如: %s_user_data_dir"
                    ></el-input>
                  </el-form-item>
                </el-col>
              </el-row>
              <el-row :gutter="20">
                <el-col :span="12">
                  <el-form-item label="起始页">
                    <el-input-number
                      v-model="form.start_page"
                      :min="1"
                    ></el-input-number>
                  </el-form-item>
                </el-col>
                <el-col :span="12">
                  <el-form-item label="最大并发数">
                    <el-input-number
                      v-model="form.max_concurrency_num"
                      :min="1"
                    ></el-input-number>
                  </el-form-item>
                </el-col>
              </el-row>
              <el-row :gutter="20">
                <el-col :span="12">
                  <el-form-item label="启用词云">
                    <el-switch v-model="form.enable_get_wordcloud"></el-switch>
                  </el-form-item>
                </el-col>
                <el-col :span="12">
                  <el-form-item label="停用词文件">
                    <el-input v-model="form.stop_words_file"></el-input>
                  </el-form-item>
                </el-col>
              </el-row>
              <el-row :gutter="20">
                <el-col :span="12">
                  <el-form-item label="字体文件">
                    <el-input v-model="form.font_path"></el-input>
                  </el-form-item>
                </el-col>
              </el-row>
            </el-card>

            <el-form-item>
              <el-button type="primary" @click="saveConfig">保存配置</el-button>
            </el-form-item>
          </el-form>

          <div v-if="currentPage === '运行爬虫'">
            <el-form ref="runForm" :model="form" label-width="120px">
              <el-card class="config-card">
                <div slot="header">
                  <span>基本配置</span>
                </div>
                <el-row :gutter="20">
                  <el-col :span="12">
                    <el-form-item label="平台">
                      <el-select
                        v-model="form.platform"
                        placeholder="请选择平台"
                      >
                        <el-option label="小红书" value="xhs"></el-option>
                        <el-option label="抖音" value="dy"></el-option>
                        <el-option label="快手" value="ks"></el-option>
                        <el-option label="B站" value="bili"></el-option>
                        <el-option label="微博" value="wb"></el-option>
                        <el-option label="贴吧" value="tieba"></el-option>
                        <el-option label="知乎" value="zhihu"></el-option>
                      </el-select>
                    </el-form-item>
                  </el-col>
                  <el-col :span="12">
                    <el-form-item label="登录类型">
                      <el-select
                        v-model="form.login_type"
                        placeholder="请选择登录类型"
                      >
                        <el-option label="二维码" value="qrcode"></el-option>
                        <el-option label="手机" value="phone"></el-option>
                        <el-option label="Cookie" value="cookie"></el-option>
                      </el-select>
                    </el-form-item>
                  </el-col>
                </el-row>
                <el-row :gutter="20">
                  <el-col :span="12">
                    <el-form-item label="爬取类型">
                      <el-select
                        v-model="form.crawler_type"
                        placeholder="请选择爬取类型"
                      >
                        <el-option
                          label="关键词搜索"
                          value="search"
                        ></el-option>
                        <el-option label="帖子详情" value="detail"></el-option>
                        <el-option
                          label="创作者主页数据"
                          value="creator"
                        ></el-option>
                      </el-select>
                    </el-form-item>
                  </el-col>
                  <el-col :span="12">
                    <el-form-item label="关键词">
                      <el-input v-model="form.keywords"></el-input>
                    </el-form-item>
                  </el-col>
                </el-row>
                <el-row :gutter="20">
                  <el-col :span="12">
                    <el-form-item label="无头模式">
                      <el-switch v-model="form.headless"></el-switch>
                    </el-form-item>
                  </el-col>
                  <el-col :span="12">
                    <el-form-item label="保存登录状态">
                      <el-switch v-model="form.save_login_state"></el-switch>
                    </el-form-item>
                  </el-col>
                </el-row>
                <el-row :gutter="20">
                  <el-col :span="12">
                    <el-form-item label="数据保存类型">
                      <el-select
                        v-model="form.save_data_option"
                        placeholder="请选择数据保存类型"
                      >
                        <el-option label="CSV" value="csv"></el-option>
                        <el-option label="数据库" value="db"></el-option>
                        <el-option label="JSON" value="json"></el-option>
                      </el-select>
                    </el-form-item>
                  </el-col>
                  <el-col :span="12">
                    <el-form-item label="最大爬取数量">
                      <el-input-number
                        v-model="form.crawler_max_notes_count"
                        :min="1"
                      ></el-input-number>
                    </el-form-item>
                  </el-col>
                </el-row>
                <el-row :gutter="20">
                  <el-col :span="12">
                    <el-form-item label="爬取图片">
                      <el-switch v-model="form.enable_get_images"></el-switch>
                    </el-form-item>
                  </el-col>
                  <el-col :span="12">
                    <el-form-item label="爬取评论">
                      <el-switch v-model="form.enable_get_comments"></el-switch>
                    </el-form-item>
                  </el-col>
                </el-row>
                <el-row :gutter="20">
                  <el-col :span="12">
                    <el-form-item label="爬取二级评论">
                      <el-switch
                        v-model="form.enable_get_sub_comments"
                      ></el-switch>
                    </el-form-item>
                  </el-col>
                </el-row>
              </el-card>
            </el-form>

            <div class="action-buttons">
              <el-button
                type="primary"
                @click="submitForm"
                :disabled="isRunning"
                icon="el-icon-video-play"
                >开始运行</el-button
              >
              <el-button
                type="danger"
                @click="stopCrawler"
                :disabled="!isRunning || isStopping"
                :loading="isStopping"
                icon="el-icon-video-pause"
                v-text="isStopping ? '正在停止' : '停止运行'"
              ></el-button>
              <el-button @click="clearBrowserData" type="warning"
                >清理浏览器数据</el-button
              >
            </div>

            <el-card class="log-window" v-if="isRunning || logs">
              <div slot="header">
                <span>运行日志</span>
              </div>
              <pre v-html="logs"></pre>
            </el-card>
          </div>
        </el-main>
      </el-container>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/vue@2.6.14/dist/vue.js"></script>
    <script src="https://unpkg.com/element-ui/lib/index.js"></script>
    <script>
      new Vue({
        el: "#app",
        data: {
          currentPage: "运行爬虫",
          form: {
            platform: "xhs",
            crawler_type: "search",
            keywords: "",
            login_type: "qrcode",
            headless: true,
            save_login_state: true,
            save_data_option: "csv",
            crawler_max_notes_count: 100,
            enable_get_images: false,
            enable_get_comments: false,
            enable_get_sub_comments: false,
            enable_ip_proxy: false,
            ip_proxy_pool_count: 2,
            ip_proxy_provider_name: "kuaidaili",
            user_data_dir: "%s_user_data_dir",
            start_page: 1,
            max_concurrency_num: 1,
            enable_get_wordcloud: false,
            stop_words_file: "./docs/hit_stopwords.txt",
            font_path: "./docs/STZHONGS.TTF",
            cookies: "",
            sort_type: "",
            xhs_creator_id_list: [],
            xhs_specified_id_list: [],
            dy_creator_id_list: [],
            dy_specified_id_list: [],
            ks_creator_id_list: [],
            ks_specified_id_list: [],
            wb_creator_id_list: [],
            wb_specified_id_list: [],
            zhihu_creator_id_list: [],
            zhihu_specified_id_list: [],
            tieba_creator_id_list: [],
            tieba_specified_id_list: [],
            bili_creator_id_list: [],
            bili_specified_id_list: [],
          },
          isRunning: false,
          isStopping: false,
          logs: "",
        },
        methods: {
          handleSelect(key) {
            this.currentPage = key;
          },
          saveConfig() {
            // 保存配置到后端
            fetch('{{ url_for("webapp.save_config") }}', {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
              },
              body: JSON.stringify(this.form),
            })
              .then((response) => response.json())
              .then((data) => {
                if (data.status === "success") {
                  this.$message.success("配置保存成功");
                } else {
                  this.$message.error("配置保存失败");
                }
              });
          },
          submitForm() {
            this.isRunning = true;
            this.logs = "";
            fetch('{{ url_for("webapp.run") }}', {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
              },
              body: JSON.stringify(this.form),
            })
              .then((response) => response.json())
              .then((data) => {
                if (data.status === "started") {
                  this.pollLogs();
                }
              });
          },
          stopCrawler() {
            this.isStopping = true;
            fetch('{{ url_for("webapp.stop") }}')
              .then((response) => response.json())
              .then((data) => {
                if (data.status === "success") {
                  this.isRunning = false;
                  this.$message.success(data.message);
                } else {
                  this.$message.error(data.message);
                }
              })
              .catch((error) => {
                this.$message.error("停止爬虫时发生错误: " + error);
              })
              .finally(() => {
                this.isStopping = false;
              });
          },
          pollLogs() {
            fetch('{{ url_for("webapp.logs") }}')
              .then((response) => response.json())
              .then((data) => {
                this.logs = data.logs;
                if (this.isRunning) {
                  setTimeout(this.pollLogs, 1000);
                }
              })
              .catch((error) => {
                console.error("Error fetching logs:", error);
                if (this.isRunning) {
                  setTimeout(this.pollLogs, 1000);
                }
              });
          },
          clearBrowserData() {
            fetch('{{ url_for("webapp.clear_browser_data") }}', {
              method: "POST",
            })
              .then((response) => response.json())
              .then((data) => {
                if (data.status === "success") {
                  this.$message.success(data.message);
                } else {
                  this.$message.error(data.message);
                }
              })
              .catch((error) => {
                this.$message.error("清理浏览器数据时发生错误: " + error);
              });
          },
        },
        mounted() {
          // 在组件挂载后，确保菜单项正确高亮
          this.$nextTick(() => {
            const menu = this.$el.querySelector(".el-menu");
            if (menu) {
              menu.__vue__.activeIndex = this.currentPage;
            }
          });
        },
      });
    </script>
  </body>
</html>
